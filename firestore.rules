rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- üõ°Ô∏è AUTHORITY HELPERS ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }
    
    function isSuper() {
      return isAdmin() && request.auth.token.admin_role == 'super';
    }

    // --- üßæ AUDIT & GOVERNANCE ---
    match /admin_audit_logs/{logId} {
      allow read, create: if isAdmin();
      allow update, delete: if false; 
    }

    match /proposed_actions/{id} {
      allow read, write: if isAdmin();
    }

    // --- üë• SILOED IDENTITY DOMAINS ---

    // 1. Consumer Domain
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isAdmin() || (isSignedIn() && request.auth.uid == userId 
                      && !request.resource.data.diff(resource.data).affectedKeys()
                          .hasAny(['role', 'admin_role', 'admin', 'isBanned']));
    }

    // 2. Business Domains (Entity Records)
    match /venues/{venueId} {
      allow read: if true; 
      allow write: if isAdmin(); 
    }

    match /hosts/{hostId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.ownerUid == request.auth.uid);
      allow write: if isAdmin();
    }

    match /promoters/{promoterId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.ownerUid == request.auth.uid);
      allow write: if isAdmin();
    }

    // 3. Admin Domain
    match /admins/{adminId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == adminId);
      allow write: if isSuper();
    }

    // 4. Onboarding & Memberships
    match /onboarding_requests/{requestId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isSignedIn();
      allow update: if isAdmin();
    }

    match /partner_memberships/{id} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow write: if isAdmin();
    }

    // --- üì¶ OPERATIONAL DATA ---
    match /events/{eventId} {
      // Drafts and sensitive states are restricted
      allow read: if isAdmin() || 
                    (resource.data.lifecycle in ['scheduled', 'live', 'completed', 'cancelled'] && !resource.data.isDeleted) ||
                    (isSignedIn() && (
                        resource.data.creatorId == request.auth.uid || 
                        resource.data.venueId == request.auth.uid ||
                        resource.data.hostId == request.auth.uid ||
                        request.auth.token.partnerId == resource.data.creatorId ||
                        request.auth.token.partnerId == resource.data.venueId ||
                        request.auth.token.partnerId == resource.data.hostId
                    ));
      allow write: if isAdmin(); // Partners write via server routes
    }

    // --- üé™ EVENT MANAGEMENT ---
    
    // Slot Requests: Host requests venue slots from clubs
    match /slot_requests/{requestId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.hostId == request.auth.uid ||
        resource.data.clubId == request.auth.uid
      ));
      allow create: if isSignedIn(); // Hosts can create requests
      allow update: if isAdmin() || (isSignedIn() && 
        resource.data.clubId == request.auth.uid); // Clubs can approve/reject
    }

    // Club Calendar: Venue availability
    match /club_calendar/{calendarId} {
      allow read: if isSignedIn(); // Partners can view availability
      allow write: if isAdmin(); // Only clubs via backend can modify
    }

    // --- üíº PROMOTER SYSTEM ---
    
    // Promoter Links: Affiliate tracking
    match /promoter_links/{linkId} {
      allow read: if isAdmin() || (isSignedIn() && 
        resource.data.promoterId == request.auth.uid);
      allow create: if isSignedIn(); // Promoters can create links
      allow update: if isAdmin(); // Stats updates go through backend
    }

    // Promoter Commissions: Earnings tracking
    match /promoter_commissions/{commissionId} {
      allow read: if isAdmin() || (isSignedIn() && 
        resource.data.promoterId == request.auth.uid);
      allow write: if isAdmin(); // Only backend can create/update
    }

    // Promoter Connections: Partnership requests between promoters and hosts/clubs
    match /promoter_connections/{connectionId} {
      // Promoters can read their own requests, hosts/clubs can read requests targeting them
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.promoterId == request.auth.uid ||
        resource.data.targetId == request.auth.uid ||
        resource.data.targetId == request.auth.token.partnerId
      ));
      // Promoters can create new connection requests
      allow create: if isSignedIn();
      // Hosts/clubs can approve/reject requests targeting them, promoters can cancel their own
      allow update: if isAdmin() || (isSignedIn() && (
        resource.data.targetId == request.auth.uid ||
        resource.data.targetId == request.auth.token.partnerId ||
        resource.data.promoterId == request.auth.uid
      ));
      // Only admins can delete connection records
      allow delete: if isAdmin();
    }

    // Partnerships: Host-Club relationships
    match /partnerships/{partnershipId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.hostId == request.auth.uid ||
        resource.data.clubId == request.auth.uid
      ));
      allow create: if isSignedIn(); // Hosts can request partnerships
      allow update: if isAdmin() || (isSignedIn() && 
        resource.data.clubId == request.auth.uid); // Clubs can approve
    }

    // --- üîî PARTNER NOTIFICATIONS ---
    
    // Notification Reads: Track which notifications partners have seen
    match /notification_reads/{readId} {
      allow read: if isAdmin() || (isSignedIn() && 
        resource.data.venueId == request.auth.token.partnerId);
      allow write: if isSignedIn() && 
        request.resource.data.venueId == request.auth.token.partnerId;
    }

    // Table Reservations: Customer table booking requests
    match /table_reservations/{reservationId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.venueId == request.auth.token.partnerId ||
        resource.data.customerId == request.auth.uid
      ));
      allow create: if isSignedIn();
      allow update: if isAdmin() || (isSignedIn() && 
        resource.data.venueId == request.auth.token.partnerId);
      allow delete: if isAdmin();
    }

    // Payouts: Partner payouts tracking
    match /payouts/{payoutId} {
      allow read: if isAdmin() || (isSignedIn() && 
        resource.data.venueId == request.auth.token.partnerId);
      allow write: if isAdmin();
    }

    match /orders/{orderId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.uid == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        resource.data.customerId == request.auth.uid ||
        resource.data.venueId == request.auth.token.partnerId
      ));
      allow create: if isSignedIn() && (
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.uid == request.auth.uid ||
        request.resource.data.customerId == request.auth.uid
      );
      allow update, delete: if isAdmin();
    }

    // --- üéüÔ∏è TICKETING SYSTEM (Phase 1) ---
    
    // Cart Reservations: Temporary ticket holds
    match /cart_reservations/{reservationId} {
      allow read: if isAdmin() || (isSignedIn() && 
        resource.data.customerId == request.auth.uid);
      allow create: if isSignedIn(); // Users can create reservations
      allow update: if isAdmin(); // Only backend updates status
      allow delete: if isAdmin();
    }

    // Refund Requests: User refund requests with admin approval
    match /refund_requests/{requestId} {
      allow read: if isAdmin() || (isSignedIn() && 
        resource.data.customerId == request.auth.uid);
      allow create: if isSignedIn(); // Users can request refunds
      allow update: if isAdmin(); // Only admins can approve/reject
      allow delete: if false; // Refund requests are immutable
    }

    // Ticket Scans: Entry validation logs
    match /ticket_scans/{scanId} {
      allow read: if isAdmin() || (isSignedIn() && (
        // Club staff can read scans for their events
        resource.data.scannedBy.uid == request.auth.uid
      ));
      allow create: if isSignedIn(); // Staff can create scans
      allow update, delete: if false; // Scans are immutable
    }

    // Club Staff: Staff management for venues
    match /club_staff/{staffId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.clubId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      ));
      allow create: if isSignedIn(); // Clubs can invite staff
      allow update: if isAdmin() || (isSignedIn() && 
        resource.data.clubId == request.auth.uid); // Clubs can update their staff
      allow delete: if isAdmin() || (isSignedIn() && 
        resource.data.clubId == request.auth.uid);
    }

    // Bound Devices: Scanner device binding
    match /bound_devices/{deviceId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.clubId == request.auth.uid ||
        resource.data.staffId == request.auth.uid
      ));
      allow write: if isAdmin() || (isSignedIn() && 
        resource.data.clubId == request.auth.uid);
    }

    // Promo Code Redemptions: Track code usage
    match /promo_redemptions/{redemptionId} {
      allow read: if isAdmin();
      allow create: if isSignedIn(); // Backend creates on checkout
      allow update, delete: if false; // Redemptions are immutable
    }

    // --- üí¨ EVENT SOCIAL LAYER ---
    
    // Helper: Check if user has a valid ticket for the event
    function hasEventTicket(eventId) {
      return exists(/databases/$(database)/documents/orders/$(request.auth.uid + '_' + eventId)) ||
             getAfter(/databases/$(database)/documents/orders).data.eventId == eventId;
    }
    
    // Event Group Chat Messages
    match /eventGroupMessages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin(); // Only moderators can update (delete flag)
      allow delete: if false; // Never hard delete, use soft delete
    }
    
    // Private Conversations (DM threads)
    match /privateConversations/{convoId} {
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow delete: if false; // Never delete conversations
    }
    
    // Direct Messages
    match /directMessages/{messageId} {
      // Allow read if user is part of the conversation
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false; // Messages are immutable
    }
    
    // Saved Contacts (persist after events)
    match /savedContacts/{contactId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Event Media (photo gallery)
    match /eventMedia/{mediaId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
    }
    
    // Typing Indicators (ephemeral)
    match /typingIndicators/{indicatorId} {
      allow read, write: if isSignedIn();
    }
    
    // User Blocks
    match /userBlocks/{blockId} {
      allow read: if isSignedIn() && (
        resource.data.blockerId == request.auth.uid ||
        resource.data.blockedId == request.auth.uid
      );
      allow create: if isSignedIn() && request.resource.data.blockerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.blockerId == request.auth.uid;
      allow update: if false; // Blocks are immutable
    }
    
    // User Reports
    match /userReports/{reportId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.reporterId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      allow update: if isAdmin(); // Only admins can update report status
      allow delete: if false; // Reports are immutable
    }
    
    // Media Reports
    match /mediaReports/{reportId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // Event Mutes (moderator action)
    match /eventMutes/{muteId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow write: if isAdmin();
    }
    
    // Event Chat Removals (moderator action)
    match /eventChatRemovals/{removalId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow write: if isAdmin();
    }
    
    // Event Chats (legacy, for backwards compatibility)
    match /eventChats/{chatId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }
    
    // Event Messages (legacy)
    match /eventMessages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
    
    // Direct Chats (legacy)
    match /directChats/{chatId} {
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
    }

    // --- üé´ TICKET SHARING & TRANSFERS ---
    
    match /share_bundles/{bundleId} {
      // Read if you are the owner or querying by token
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        request.query.limit <= 1 // Allow looking up specific token if where filter is used
      ));
      allow write: if isAdmin(); 
    }

    match /ticket_assignments/{assignmentId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.redeemerId == request.auth.uid ||
        resource.data.originalPurchaserId == request.auth.uid
      ));
      allow write: if isAdmin();
    }

    match /transfers/{transferId} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      ));
      allow create: if isSignedIn() && request.resource.data.fromUserId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      ));
      allow delete: if false;
    }

    match /couple_assignments/{id} {
      allow read: if isAdmin() || (isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.partnerId == request.auth.uid
      ));
      allow write: if isAdmin();
    }

    match /couple_claims/{id} {
      allow read: if isAdmin() || isSignedIn(); // Token lookup usually
      allow write: if isAdmin();
    }

    match /rsvp_orders/{orderId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // --- üè¢ ADMIN HARROGATE (REFINED) ---
    
    match /admin_logs/{logId} {
      allow read, create: if isAdmin();
      allow update, delete: if false;
    }
    
    match /admin_proposed_actions/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /host_applications/{id} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isSignedIn();
      allow update: if isAdmin();
    }

    match /platform_settings/{id} {
      allow read: if isSignedIn();
      allow write: if isSuper();
    }

    // --- ‚öôÔ∏è CONFIGURATION & CMS ---
    match /app_config/{configId} {
      allow read: if true; 
      allow write: if isAdmin(); 
    }

    // --- ü§ù PUBLIC SHARING (Phase 3 Prep) ---
    match /public_attendees/{id} {
      allow read: if isSignedIn();
      allow write: if false; // Server only
    }

    // --- üèÅ DEFAULT CATCH-ALL (STRICT) ---
    match /{document=**} {
      allow read: if isAdmin();
      allow write: if false;
    }
  }
}
