rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- üõ°Ô∏è CRYPTOGRAPHIC IDENTITY HELPERS ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Enforce that only users with the 'admin' claim (set via Firebase Admin SDK) 
    // can access administrative data. We don't trust the Firestore document 'role' field.
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }
    
    function isSuper() {
      return isAdmin() && request.auth.token.admin_role == 'super';
    }

    // --- üßæ TASK 3: IMMUTABLE AUDIT TRAIL ---
    match /admin_logs/{logId} {
      // Allow admins to read logs for the UI
      allow read: if isAdmin();
      // Only the server (Admin SDK) should be writing these, but we keep create: if isAdmin 
      // as a fallback for potential future client-side logging if ever needed, 
      // but CRITICALLY: update and delete are forbidden forever.
      allow create: if isAdmin();
      allow update, delete: if false; 
    }

    // --- üö¶ PLATFORM COMMAND DATA ---
    match /platform_stats/{stat} {
      allow read: if isAdmin();
      allow write: if false; // Only server-side Admin SDK via increment/set
    }

    // --- üèõÔ∏è SHARED DIRECTORIES ---
    
    match /venues/{venueId} {
      allow read: if true; // Publicly visible for exploration
      allow write: if isAdmin(); // Only admins can onboard/suspend
    }

    match /events/{eventId} {
      allow read: if true; 
      allow write: if isAdmin(); 
      // Specific restriction: Non-admins cannot edit event status
    }

    match /host_applications/{appId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isSignedIn();
      allow update: if isAdmin(); // Only admins can approve/reject
      allow delete: if false;
    }

    // --- üë§ USER IDENTITY ---
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      // Prevent role escalation: Users cannot change their own 'role' or 'isBanned' status
      allow write: if isAdmin() || (isSignedIn() && request.auth.uid == userId 
                      && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['role', 'isBanned', 'admin_role', 'admin']));
    }

    // --- üì¶ DEFAULT CATCH-ALL (DENY BY DEFAULT) ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
